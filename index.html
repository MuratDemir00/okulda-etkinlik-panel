<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <title>Firestore Y√∂netim Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --accent: #22c55e;
            --warn: #ef4444;
            --line: #1f2937;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu
        }

        header {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--line)
        }

        h1 {
            font-size: 16px;
            margin: 0
        }

        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .tab {
            background: #65779c;
            border: 1px solid var(--line);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer
        }

        .tab.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        main {
            padding: 16px;
            display: grid;
            gap: 16px
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 16px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        input,
        select,
        textarea {
            background: #0b1220;
            border: 1px solid var(--line);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 8px;
            min-width: 180px
        }

        textarea {
            min-width: 280px;
            min-height: 80px
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            border-bottom: 1px solid var(--line);
            padding: 8px;
            text-align: left;
            vertical-align: top
        }

        .muted {
            color: var(--muted)
        }

        .btn {
            cursor: pointer;
            border: 1px solid var(--line);
            background: #0b1220;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px
        }

        .btn.primary {
            background: var(--accent);
            color: #06200f;
            border-color: #0f3a20
        }

        .btn.warn {
            background: var(--warn);
            color: #1e0b0b;
            border-color: #3f0a0a
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px
        }

        .pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            background: #0b1220;
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 4px 8px
        }

        .tag {
            border: 1px solid var(--line);
            padding: 2px 6px;
            border-radius: 999px
        }

        .help {
            font-size: 12px;
            color: var(--muted)
        }

        .hidden {
            display: none
        }

        .hr {
            height: 1px;
            background: var(--line);
            margin: 12px 0
        }

        .danger {
            color: #fca5a5
        }

        .success {
            color: #86efac
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
        }

        .small {
            font-size: 12px
        }

        .content-field {
            width: 100%;
        }

        .grid-2,
        .grid-3 {
            display: grid;
            gap: 12px;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .small {
            font-size: 12px;
        }

        .hidden {
            display: none !important;
        }

        .content-preview {
            max-width: 300px;
            max-height: 48px;
            overflow: hidden;
            white-space: normal;
            line-height: 1.3;
            cursor: pointer;
            transition: max-height 0.25s ease;
        }

        /* Hover ile tam a√ß */
        .content-preview:hover {
            max-height: 200px;
            overflow-y: auto;
            background: #0b1220;
            padding: 6px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <header>
        <h1>üìö Firestore Y√∂netim Paneli</h1>
        <div class="tabs">
            <button class="tab active" data-tab="movingTexts">movingTexts</button>
            <button class="tab" data-tab="appSettings">app_settings / ads</button>
            <button class="tab" data-tab="topCategories">topCategories</button>
        </div>
    </header>

    <main>
        <!-- movingTexts -->
        <section id="movingTexts" class="card">
            <h2>üìù movingTexts</h2>
            <div class="row">
                <input id="mt-text" placeholder="Metin..." />
                <button class="btn primary" id="mt-add">Ekle</button>
                <span id="mt-status" class="help"></span>
            </div>
            <div class="hr"></div>
            <table>
                <thead>
                    <tr>
                        <th>Doc ID</th>
                        <th>text</th>
                        <th>ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="mt-list"></tbody>
            </table>
        </section>

        <!-- app_settings / ads -->
        <section id="appSettings" class="card hidden">
            <h2>‚öôÔ∏è app_settings / <code>ads</code></h2>
            <div class="grid-3">
                <label>bannerEnabled<br><input type="checkbox" id="as-banner" /></label>
                <label>interstitialEnabled<br><input type="checkbox" id="as-interstitial" /></label>
                <label>showEveryX<br><input type="number" id="as-every" min="1" step="1" /></label>
                <label>useTestBannerIds<br><input type="checkbox" id="as-testb" /></label>
                <label>useTestInterstitialIds<br><input type="checkbox" id="as-testi" /></label>
            </div>
            <div class="row" style="margin-top:10px">
                <button class="btn primary" id="as-save">Kaydet</button>
                <span id="as-status" class="help"></span>
            </div>
        </section>

        <!-- topCategories -->
        <section id="topCategories" class="card hidden">

            <h2>üóÇÔ∏è topCategories</h2>
            <!-- üî• Sort Order butonu (BURAYI YENƒ∞ EKLE) -->
            <div class="row" style="margin-bottom: 10px;">
                <button class="btn primary" id="fix-sort-order">Sort Order D√ºzelt / Ekle</button>
                <span id="sort-status" class="help"></span>
            </div>
            <!-- üî• /Sort Order butonu -->


            <!-- Kategori ekle/d√ºzenle -->
            <div class="card" style="margin-bottom:12px">
                <div class="row">
                    <input id="tc-id" placeholder="id (√∂r: funny_texts)" />
                    <input id="tc-name" placeholder="name" />
                    <input id="tc-image" placeholder="imageUrl (https://...)" />
                    <input id="tc-sort" type="number" placeholder="sort_order (opsiyonel)" />
                    <input id="tc-type" placeholder='type (opsiyonel, √∂r: "grades" / "special" / "simple")' />
                    <button class="btn primary" id="tc-save">Kaydet / G√ºncelle</button>
                    <span id="tc-status" class="help"></span>
                </div>
            </div>

            <!-- Kategoriler Listesi -->
            <table>
                <thead>
                    <tr>
                        <th>id</th>
                        <th>name</th>
                        <th>imageUrl</th>
                        <th class="small">sort/type</th>
                        <th>Alt Kategori</th>
                        <th>Sil</th>
                    </tr>
                </thead>
                <tbody id="tc-list"></tbody>
            </table>

            <!-- Alt kategori y√∂neticisi -->
            <div id="sc-box" class="card hidden" style="margin-top:16px">
                <h3>üìé SubCategories ‚Äî <span id="sc-category-label" class="muted"></span></h3>

                <div class="row">
                    <input id="sc-id" placeholder="id (√∂r: bilmece)" />
                    <input id="sc-name" placeholder="name" />
                    <div class="pill">
                        <span class="muted small">availableTypes</span>
                        <label class="small"><input type="checkbox" class="sc-type" value="text"> text</label>
                        <label class="small"><input type="checkbox" class="sc-type" value="image"> image</label>
                        <label class="small"><input type="checkbox" class="sc-type" value="video"> video</label>
                        <label class="small"><input type="checkbox" class="sc-type" value="audio"> audio</label>
                        <label class="small"><input type="checkbox" class="sc-type" value="activity"> activity</label>
                        <label class="small"><input type="checkbox" class="sc-type" value="pdf"> pdf</label>
                    </div>
                    <button class="btn primary" id="sc-save">Alt Kategori Kaydet</button>
                    <span id="sc-status" class="help"></span>
                </div>

                <div class="hr"></div>

                <table>
                    <thead>
                        <tr>
                            <th>id</th>
                            <th>name</th>
                            <th>availableTypes</th>
                            <th>D√ºzenle</th>
                            <th>Sil</th>
                        </tr>
                    </thead>
                    <tbody id="sc-list"></tbody>
                </table>

                <!-- funny_texts i√ßin items -->
                <div id="items-box" class="card hidden" style="margin-top:16px">
                    <h4>üéØ Items (sadece <code>funny_texts</code> kategorisi i√ßin)</h4>

                    <div class="row">
                        <input id="it-id" placeholder="id (√∂r: bilmece_1)" />
                        <select id="it-type">
                            <option value="text">text</option>
                            <option value="image">image</option>
                            <option value="video">video</option>
                            <option value="audio">audio</option>
                            <option value="pdf">pdf</option>
                        </select>
                        <input id="it-title" placeholder="title" />
                    </div>

                    <div class="row" style="margin-top:8px">
                        <textarea id="it-text" placeholder="text (type=text ise)"></textarea>
                        <input id="it-image" placeholder="imageUrl (type=image ise)" />
                        <input id="it-video" placeholder="videoUrl (type=video ise)" />
                        <input id="it-audio" placeholder="audioUrl (type=audio ise)" />
                        <input id="it-pdf" placeholder="pdfUrl (type=pdf ise)" />
                        <button class="btn primary" id="it-save">Item Kaydet</button>
                        <span id="it-status" class="help"></span>
                    </div>

                    <div class="hr"></div>
                    <table>
                        <thead>
                            <tr>
                                <th>id</th>
                                <th>type</th>
                                <th>title</th>
                                <th>ƒ∞√ßerik</th>
                                <th>Sil</th>
                            </tr>
                        </thead>
                        <tbody id="it-list"></tbody>
                    </table>
                </div>

                <!-- GRADES DERS / KONU / ƒ∞√áERƒ∞K Y√ñNETƒ∞Cƒ∞Sƒ∞ -->
                <div id="grades-box" class="card hidden" style="margin-top:16px">
                    <h3>üìö Dersler (Lessons)</h3>

                    <div class="row">
                        <input id="lesson-id" placeholder="Ders id (√∂r: fen)" />
                        <input id="lesson-name" placeholder="Ders adƒ± (√ñrn: Fen Bilimleri)" />
                        <button class="btn primary" id="lesson-save">Ders Kaydet</button>
                    </div>

                    <div class="hr"></div>
                    <table>
                        <thead>
                            <tr>
                                <th>id</th>
                                <th>name</th>
                                <th>Konular</th>
                                <th>Sil</th>
                            </tr>
                        </thead>
                        <tbody id="lesson-list"></tbody>
                    </table>

                    <div id="topics-box" class="card hidden" style="margin-top:16px">
                        <h4>üìò Konular (Topics) ‚Äî <span id="lesson-label"></span></h4>

                        <div class="row">
                            <input id="topic-id" placeholder="Konu id (√∂r: besinler)" />
                            <input id="topic-name" placeholder="Konu adƒ± (√ñrn: Besinler)" />
                            <button class="btn primary" id="topic-save">Konu Kaydet</button>
                        </div>

                        <div class="hr"></div>
                        <table>
                            <thead>
                                <tr>
                                    <th>id</th>
                                    <th>name</th>
                                    <th>ƒ∞√ßerik</th>
                                    <th>Sil</th>
                                </tr>
                            </thead>
                            <tbody id="topic-list"></tbody>
                        </table>

                        <div id="content-box" class="card hidden" style="margin-top:16px">
                            <h4>üìÇ ƒ∞√ßerikler ‚Äî <span id="topic-label"></span></h4>

                            <div class="grid-3" style="margin-bottom:12px">
                                <label class="small muted">ƒ∞√ßerik T√ºr√º
                                    <select id="content-type">
                                        <option value="text">Metin</option>
                                        <option value="image">G√∂rsel</option>
                                        <option value="audio">Ses</option>
                                        <option value="video">Video</option>
                                        <option value="pdf">PDF</option>
                                        <option value="activity">Etkinlik</option>
                                    </select>
                                </label>

                                <label class="small muted">ƒ∞√ßerik ID
                                    <input id="content-id" placeholder="√ñrn: besinler_siir_1" />
                                </label>

                                <label class="small muted">Ba≈ülƒ±k
                                    <input id="content-title" placeholder="Ba≈ülƒ±k" />
                                </label>
                            </div>

                            <div class="grid-2" style="margin-bottom:12px">
                                <textarea id="content-text" placeholder="Metin / Etkinlik i√ßin i√ßerik"
                                    class="content-field content-text"></textarea>

                                <input id="content-image" placeholder="imageUrl (G√∂rsel)"
                                    class="content-field content-image hidden" />
                                <input id="content-audio" placeholder="audioUrl (Ses)"
                                    class="content-field content-audio hidden" />
                                <input id="content-video" placeholder="videoUrl (Video)"
                                    class="content-field content-video hidden" />
                                <input id="content-pdf" placeholder="pdfUrl (PDF)"
                                    class="content-field content-pdf hidden" />
                            </div>

                            <button class="btn primary" id="content-save" style="margin-bottom:10px">‚ûï ƒ∞√ßerik
                                Ekle</button>

                            <div class="hr"></div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>id</th>
                                        <th>Ba≈ülƒ±k</th>
                                        <th>T√ºr</th>
                                        <th>ƒ∞√ßerik</th>
                                        <th>Sil</th>
                                    </tr>
                                </thead>
                                <tbody id="content-list"></tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>

        </section>
    </main>

    <script type="module">
        // ===== Firebase =====
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore, collection, doc, getDoc, getDocs,
            addDoc, setDoc, updateDoc, deleteDoc, query, orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ----->>> BURAYI DOLDUR
        const firebaseConfig = {
            apiKey: "AIzaSyDNnwOr-HT_05r_bQfyB9xqgVSkZCKDO0Y",
            authDomain: "okulda-etkinlik.firebaseapp.com",
            projectId: "okulda-etkinlik",
            storageBucket: "okulda-etkinlik.firebasestorage.app",
            messagingSenderId: "961658300317",
            appId: "1:961658300317:web:cdece73a10956f8709f174",
            measurementId: "G-7Z4LBDZ169"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ===== yardƒ±mcƒ±lar =====
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const toast = (el, msg, ok = true) => { el.textContent = msg; el.className = 'help ' + (ok ? 'success' : 'danger'); setTimeout(() => { el.textContent = ''; el.className = 'help'; }, 2000); };

        // ===== Tablar =====
        $$('.tab').forEach(t => {
            t.addEventListener('click', () => {
                $$('.tab').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                const id = t.dataset.tab;
                $('section#movingTexts').classList.add('hidden');
                $('section#appSettings').classList.add('hidden');
                $('section#topCategories').classList.add('hidden');
                $('section#' + id).classList.remove('hidden');
            });
        });

        // =========================
        // movingTexts
        // =========================
        async function loadMovingTexts() {
            const listEl = $('#mt-list');
            listEl.innerHTML = '<tr><td colspan="3" class="muted">Y√ºkleniyor‚Ä¶</td></tr>';
            const snap = await getDocs(collection(db, 'movingTexts'));
            let rows = '';
            snap.forEach(d => {
                const data = d.data();
                rows += `<tr>
        <td class="mono small">${d.id}</td>
        <td contenteditable data-doc="${d.id}" class="mt-cell">${data.text ?? ''}</td>
        <td>
          <button class="btn small" data-action="save" data-id="${d.id}">Kaydet</button>
          <button class="btn warn small" data-action="del" data-id="${d.id}">Sil</button>
        </td>
      </tr>`;
            });
            listEl.innerHTML = rows || '<tr><td colspan="3" class="muted">Kayƒ±t yok.</td></tr>';

            // olaylar
            listEl.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    if (btn.dataset.action === 'del') {
                        await deleteDoc(doc(db, 'movingTexts', id));
                        loadMovingTexts();
                    } else {
                        const cell = listEl.querySelector(`.mt-cell[data-doc="${id}"]`);
                        await setDoc(doc(db, 'movingTexts', id), { text: cell.textContent.trim() }, { merge: true });
                        toast($('#mt-status'), 'G√ºncellendi');
                    }
                });
            });
        }

        $('#mt-add').addEventListener('click', async () => {
            const text = $('#mt-text').value.trim();
            if (!text) { toast($('#mt-status'), 'Metin bo≈ü olamaz', false); return; }
            await addDoc(collection(db, 'movingTexts'), { text });
            $('#mt-text').value = '';
            toast($('#mt-status'), 'Eklendi');
            alert("‚úÖ Kayƒ±t ba≈üarƒ±yla eklendi!");
            loadMovingTexts();
        });

        // =========================
        // app_settings / ads
        // =========================
        async function loadAds() {
            const ref = doc(db, 'app_settings', 'ads');
            const s = await getDoc(ref);
            const d = s.exists() ? s.data() : {};
            $('#as-banner').checked = !!d.bannerEnabled;
            $('#as-interstitial').checked = !!d.interstitialEnabled;
            $('#as-every').value = d.showEveryX ?? 3;
            $('#as-testb').checked = !!d.useTestBannerIds;
            $('#as-testi').checked = !!d.useTestInterstitialIds;
        }
        $('#as-save').addEventListener('click', async () => {
            const payload = {
                bannerEnabled: $('#as-banner').checked,
                interstitialEnabled: $('#as-interstitial').checked,
                showEveryX: Number($('#as-every').value || 3),
                useTestBannerIds: $('#as-testb').checked,
                useTestInterstitialIds: $('#as-testi').checked,
            };
            await setDoc(doc(db, 'app_settings', 'ads'), payload, { merge: true });
            toast($('#as-status'), 'Kaydedildi');
        });

        // =========================
        // topCategories + subCategories + (funny_texts ‚Üí items)
        // =========================
        let currentCategoryId = null;     // alt kategori y√ºklemek i√ßin
        let currentSubCategoryId = null;  // items y√∂netimi i√ßin

        async function loadTopCategories() {
            const listEl = $('#tc-list');
            listEl.innerHTML = '<tr><td colspan="6" class="muted">Y√ºkleniyor‚Ä¶</td></tr>';

            const q = query(
                collection(db, 'topCategories'),
                orderBy('sort_order', 'asc')
            );
            const qSnap = await getDocs(q);

            let rows = '';
            qSnap.forEach(d => {
                const x = d.data();
                rows += `<tr>
            <td class="mono">${x.id ?? d.id}</td>
            <td>${x.name ?? ''}</td>
            <td class="small"><a href="${x.imageUrl ?? '#'}" target="_blank" class="muted">${(x.imageUrl || '').slice(0, 40)}‚Ä¶</a></td>
<td class="small">
    <input data-top-sort="${d.id}" 
           value="${x.sort_order ?? ''}" 
           type="number" 
           style="width:60px">
    <button class="btn small" data-top-save="${d.id}">Kaydet</button>
    <div class="small muted">${x.type ?? ''}</div>
</td>
            <td><button class="btn small" data-open="${d.id}">Alt Kategori A√ß</button></td>
            <td><button class="btn warn small" data-del="${d.id}">Sil</button></td>
        </tr>`;
            });

            listEl.innerHTML = rows || '<tr><td colspan="6" class="muted">Kayƒ±t yok.</td></tr>';

            listEl.querySelectorAll('button[data-open]').forEach(b => {
                b.addEventListener('click', () => openSubCategories(b.dataset.open));
            });
            listEl.querySelectorAll('button[data-del]').forEach(b => {
                b.addEventListener('click', async () => {
                    if (!confirm('Kategoriyi silmek alt koleksiyonlarƒ± silmez. Emin misin?')) return;
                    await deleteDoc(doc(db, 'topCategories', b.dataset.del));
                    loadTopCategories();
                });
            });
            // ---- TOP CATEGORY SORT ORDER UPDATE ----
            listEl.querySelectorAll('button[data-top-save]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.topSave;
                    const input = listEl.querySelector(`input[data-top-sort="${id}"]`);
                    const val = Number(input.value || 0);

                    await updateDoc(doc(db, 'topCategories', id), {
                        sort_order: val
                    });

                    alert("‚úÖ Top category sort_order g√ºncellendi!");
                    loadTopCategories();
                });
            });
        }

        $('#tc-save').addEventListener('click', async () => {
            const id = $('#tc-id').value.trim();
            if (!id) { toast($('#tc-status'), 'id gerekli', false); return; }
            const payload = {
                id,
                name: $('#tc-name').value.trim() || null,
                imageUrl: $('#tc-image').value.trim() || null,
                sort_order: $('#tc-sort').value ? Number($('#tc-sort').value) : null,
                type: $('#tc-type').value.trim() || null,
            };
            await setDoc(doc(db, 'topCategories', id), payload, { merge: true });
            toast($('#tc-status'), 'Kaydedildi');
            alert("‚úÖ Kategori kaydedildi!");

            loadTopCategories();
        });

        async function openSubCategories(categoryId) {
            currentCategoryId = categoryId;
            $('#sc-box').classList.remove('hidden');
            $('#sc-category-label').textContent = `category: ${categoryId}`;
            $('#items-box').classList.add('hidden'); // alt kategori se√ßilene kadar gizle
            currentSubCategoryId = null;
            $('#sc-id').value = ''; $('#sc-name').value = ''; $$('.sc-type').forEach(cb => cb.checked = false);
            // liste
            const listEl = $('#sc-list');
            listEl.innerHTML = '<tr><td colspan="5" class="muted">Y√ºkleniyor‚Ä¶</td></tr>';
            const snap = await getDocs(collection(db, 'topCategories', categoryId, 'subCategories'));
            let rows = '';
            snap.forEach(d => {
                const x = d.data();
                const types = Array.isArray(x.availableTypes) ? x.availableTypes.join(', ') : '';
                rows += `<tr>
        <td class="mono">${x.id ?? d.id}</td>
        <td>${x.name ?? ''}</td>
<td class="small">
    <input data-sub-sort="${d.id}"
           value="${x.sort_order ?? ''}"
           type="number"
           style="width:60px">
    <button class="btn small" data-sub-save="${d.id}">Kaydet</button>

    <div class="muted small">${types}</div>
</td>
        <td><button class="btn small" data-edit="${d.id}">D√ºzenle</button>
            <button class="btn small" data-items="${d.id}">Items</button></td>
        <td><button class="btn warn small" data-del="${d.id}">Sil</button></td>
      </tr>`;
            });
            listEl.innerHTML = rows || '<tr><td colspan="5" class="muted">Alt kategori yok.</td></tr>';

            listEl.querySelectorAll('button[data-edit]').forEach(b => {
                b.addEventListener('click', async () => {
                    const id = b.dataset.edit;
                    const s = await getDoc(doc(db, 'topCategories', categoryId, 'subCategories', id));
                    if (!s.exists()) return;
                    const x = s.data();
                    $('#sc-id').value = x.id ?? id;
                    $('#sc-name').value = x.name ?? '';
                    $$('.sc-type').forEach(cb => cb.checked = Array.isArray(x.availableTypes) ? x.availableTypes.includes(cb.value) : false);
                });
            });

            listEl.querySelectorAll('button[data-items]').forEach(b => {
                b.addEventListener('click', () => {
                    currentSubCategoryId = b.dataset.items;

                    // ==== GRADES ‚Üí Ders Y√∂netimi ====
                    if (currentCategoryId === 'grades') {
                        $('#grades-box').classList.remove('hidden');
                        $('#items-box').classList.add('hidden');
                        loadLessons();
                        return; // burada duruyoruz
                    }

                    // ==== FUNNY_TEXTS ‚Üí Items Y√∂netimi ====
                    if (currentCategoryId === 'funny_texts') {
                        $('#items-box').classList.remove('hidden');
                        $('#grades-box').classList.add('hidden');
                        loadItems();
                        return;
                    }

                    // ==== SPECIAL_DAYS ‚Üí Items Y√∂netimi ====
                    if (currentCategoryId === 'special_days') {
                        $('#items-box').classList.remove('hidden');
                        $('#grades-box').classList.add('hidden');
                        loadItems();
                        return;
                    }

                    // ==== Dƒ∞ƒûER KATEGORƒ∞LER ‚Üí Hi√ßbir ≈üey a√ßma ====
                    $('#grades-box').classList.add('hidden');
                    $('#items-box').classList.add('hidden');
                    alert("Bu alt kategori i√ßin √∂zel y√∂netim paneli yok.");
                });
            });

            // ---- SUBCATEGORY SORT ORDER UPDATE ----
            listEl.querySelectorAll('button[data-sub-save]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const subId = btn.dataset.subSave;
                    const input = listEl.querySelector(`input[data-sub-sort="${subId}"]`);
                    const val = Number(input.value || 0);

                    await updateDoc(
                        doc(db, 'topCategories', currentCategoryId, 'subCategories', subId),
                        { sort_order: val }
                    );

                    alert("‚úÖ Subcategory sort_order g√ºncellendi!");
                    openSubCategories(currentCategoryId);
                });
            });



            listEl.querySelectorAll('button[data-del]').forEach(b => {
                b.addEventListener('click', async () => {
                    if (!confirm('Alt kategoriyi silmek items‚Äôlarƒ± silmez. Emin misin?')) return;
                    await deleteDoc(doc(db, 'topCategories', categoryId, 'subCategories', b.dataset.del));
                    openSubCategories(categoryId);
                });
            });
        }

        $('#sc-save').addEventListener('click', async () => {
            if (!currentCategoryId) { toast($('#sc-status'), '√ñnce kategori se√ß', false); return; }
            const id = $('#sc-id').value.trim();
            if (!id) { toast($('#sc-status'), 'id gerekli', false); return; }
            const types = $$('.sc-type').filter(cb => cb.checked).map(cb => cb.value);
            const payload = {
                id,
                name: $('#sc-name').value.trim() || null,
                availableTypes: types.length ? types : null,
                // topics opsiyonel: istemiyorsan bo≈ü kalsƒ±n
            };
            await setDoc(doc(db, 'topCategories', currentCategoryId, 'subCategories', id), payload, { merge: true });
            toast($('#sc-status'), 'Alt kategori kaydedildi');
            openSubCategories(currentCategoryId);
        });

        // ===== items (funny_texts) =====
        async function loadItems() {
            if (!currentCategoryId || !currentSubCategoryId) return;
            const listEl = $('#it-list');
            listEl.innerHTML = '<tr><td colspan="5" class="muted">Y√ºkleniyor‚Ä¶</td></tr>';
            const path = collection(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'items');
            const snap = await getDocs(path);
            let rows = '';
            snap.forEach(d => {
                const x = d.data();
                const content =
                    x.type === 'text' ? (x.text ?? '') :
                        x.type === 'image' ? (x.imageUrl ?? '') :
                            x.type === 'video' ? (x.videoUrl ?? '') :
                                x.type === 'audio' ? (x.audioUrl ?? '') :
                                    x.type === 'pdf' ? (x.pdfUrl ?? '') : '';
                rows += `<tr>
        <td class="mono small">${x.id ?? d.id}</td>
        <td>${x.type ?? ''}</td>
        <td>${x.title ?? ''}</td>
<td>
    <input data-item-sort="${d.id}" 
           value="${x.sort_order ?? ''}"
           type="number" 
           style="width:60px">

    <button class="btn small" data-item-save="${d.id}">Kaydet</button>

    <div class="small mono">${(content || '').toString().slice(0, 80)}‚Ä¶</div>
</td>
        <td><button class="btn warn small" data-del="${d.id}">Sil</button></td>
      </tr>`;
            });
            listEl.innerHTML = rows || '<tr><td colspan="5" class="muted">Item yok.</td></tr>';
            // ---- ITEM SORT ORDER UPDATE ----
            listEl.querySelectorAll('button[data-item-save]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.itemSave;
                    const input = listEl.querySelector(`input[data-item-sort="${id}"]`);
                    const val = Number(input.value || 0);

                    await updateDoc(
                        doc(db,
                            'topCategories', currentCategoryId,
                            'subCategories', currentSubCategoryId,
                            'items', id
                        ),
                        { sort_order: val }
                    );

                    alert("‚úÖ Item sort_order g√ºncellendi!");
                    loadItems();
                });
            });

            listEl.querySelectorAll('button[data-del]').forEach(b => {
                b.addEventListener('click', async () => {
                    const path = doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'items', b.dataset.del);
                    await deleteDoc(path);
                    loadItems();
                });
            });
        }

        $('#it-save').addEventListener('click', async () => {

            // ‚ùó Artƒ±k funny_texts VE special_days izin veriyor
            if (!['funny_texts', 'special_days'].includes(currentCategoryId) || !currentSubCategoryId) {
                toast($('#it-status'), '√ñnce ge√ßerli bir kategori ‚Üí subCategory se√ß', false);
                return;
            }

            const id = $('#it-id').value.trim();
            const type = $('#it-type').value;
            if (!id) { toast($('#it-status'), 'id gerekli', false); return; }

            const payload = {
                id,
                type,
                title: $('#it-title').value.trim() || null,
                text: (type === 'text') ? ($('#it-text').value.trim() || null) : null,
                imageUrl: (type === 'image') ? ($('#it-image').value.trim() || null) : null,
                videoUrl: (type === 'video') ? ($('#it-video').value.trim() || null) : null,
                audioUrl: (type === 'audio') ? ($('#it-audio').value.trim() || null) : null,
                pdfUrl: (type === 'pdf') ? ($('#it-pdf').value.trim() || null) : null,
            };

            const ref = doc(
                db,
                'topCategories',
                currentCategoryId,
                'subCategories',
                currentSubCategoryId,
                'items',
                id
            );

            await setDoc(ref, payload, { merge: true });

            toast($('#it-status'), 'Item kaydedildi');

            // input temizliƒüi
            $('#it-id').value = '';
            $('#it-title').value = '';
            $('#it-text').value = '';
            $('#it-image').value = '';
            $('#it-video').value = '';
            $('#it-audio').value = '';
            $('#it-pdf').value = '';

            loadItems();
        });

        let currentLessonId = null;
        let currentTopicId = null;

        // ---- LESSONS ----
        async function loadLessons() {
            const listEl = $('#lesson-list');
            listEl.innerHTML = '<tr><td colspan="4" class="muted">Y√ºkleniyor‚Ä¶</td></tr>';

            const snap = await getDocs(
                collection(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons')
            );

            let rows = '';
            snap.forEach(d => {
                const x = d.data();
                rows += `<tr>
      <td>${x.id}</td>
      <td>${x.name || ''}</td>
<td>
    <input data-lesson-sort="${d.id}" 
           value="${x.sort_order ?? ''}"
           type="number" 
           style="width:60px">

    <button class="btn small" data-lesson-save="${d.id}">Kaydet</button>

    <button class="btn small" onclick="openTopics('${x.id}')">Konular</button>
</td>
      <td><button class="btn warn small" onclick="deleteLesson('${x.id}')">Sil</button></td>
    </tr>`;
            });

            listEl.innerHTML = rows || '<tr><td colspan="4" class="muted">Ders yok.</td></tr>';

            // ---- LESSON SORT UPDATE ----
            listEl.querySelectorAll('button[data-lesson-save]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.lessonSave;
                    const input = listEl.querySelector(`input[data-lesson-sort="${id}"]`);
                    const val = Number(input.value || 0);

                    await updateDoc(
                        doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', id),
                        { sort_order: val }
                    );

                    alert("‚úÖ Ders sort_order g√ºncellendi!");
                    loadLessons();
                });
            });

        }

        async function deleteLesson(id) {
            await deleteDoc(doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', id));
            loadLessons();
        }

        $('#lesson-save').onclick = async () => {
            const id = $('#lesson-id').value.trim();
            const name = $('#lesson-name').value.trim();
            if (!id) return alert("Ders id gerekli");
            await setDoc(
                doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', id),
                { id, name },
                { merge: true }
            );
            alert("‚úÖ Ders kaydedildi!");
            loadLessons();
        };

        // ---- TOPICS ----
        async function openTopics(lessonId) {
            currentLessonId = lessonId;
            $('#topics-box').classList.remove('hidden');
            $('#content-box').classList.add('hidden');
            $('#lesson-label').textContent = lessonId;
            loadTopics();
        }

        async function loadTopics() {
            if (!currentCategoryId || !currentSubCategoryId || !currentLessonId) {
                console.warn("loadTopics() path deƒüi≈ükenleri eksik:", {
                    currentCategoryId, currentSubCategoryId, currentLessonId
                });
                return;
            }

            const listEl = $('#topic-list');
            listEl.innerHTML = '<tr><td colspan="4" class="muted">Y√ºkleniyor‚Ä¶</td></tr>';

            const snap = await getDocs(
                collection(db,
                    'topCategories', currentCategoryId,
                    'subCategories', currentSubCategoryId,
                    'lessons', currentLessonId,
                    'topics'
                )
            );

            let rows = '';
            snap.forEach(d => {
                const x = d.data();
                rows += `<tr>
      <td>${x.id}</td>
      <td>${x.name || ''}</td>
<td>
    <input data-topic-sort="${d.id}" 
           value="${x.sort_order ?? ''}"
           type="number" 
           style="width:60px">

    <button class="btn small" data-topic-save="${d.id}">Kaydet</button>

    <button class="btn small" onclick="openContent('${x.id}')">ƒ∞√ßerik</button>
</td>
      <td><button class="btn warn small" onclick="deleteTopic('${x.id}')">Sil</button></td>
    </tr>`;
            });

            listEl.innerHTML = rows || '<tr><td colspan="4" class="muted">Konu yok.</td></tr>';

            // ---- TOPIC SORT ORDER UPDATE ----
            listEl.querySelectorAll('button[data-topic-save]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.topicSave;
                    const input = listEl.querySelector(`input[data-topic-sort="${id}"]`);
                    const val = Number(input.value || 0);

                    await updateDoc(
                        doc(db,
                            'topCategories', currentCategoryId,
                            'subCategories', currentSubCategoryId,
                            'lessons', currentLessonId,
                            'topics', id
                        ),
                        { sort_order: val }
                    );

                    alert("‚úÖ Topic sort_order g√ºncellendi!");
                    loadTopics();
                });
            });

        }

        async function deleteTopic(id) {
            await deleteDoc(doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', currentLessonId, 'topics', id));
            loadTopics();
        }

        $('#topic-save').onclick = async () => {
            const id = $('#topic-id').value.trim();
            const name = $('#topic-name').value.trim();
            if (!id) return alert("Konu id gerekli");
            await setDoc(
                doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', currentLessonId, 'topics', id),
                { id, name },
                { merge: true }
            );
            alert("‚úÖ Konu kaydedildi!");
            loadTopics();
        };

        // ---- CONTENT ----
        async function openContent(topicId) {
            currentTopicId = topicId;
            $('#content-box').classList.remove('hidden');
            updateContentFieldVisibility();
            $('#topic-label').textContent = topicId;
            loadContent();
        }
        let currentContentCount = 0;

        async function loadContent() {
            const snap = await getDoc(
                doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', currentLessonId, 'topics', currentTopicId)
            );

            const d = snap.data();
            const type = $('#content-type').value;
            const arr = (d?.content?.[type] ?? []);
            currentContentCount = arr.length + 1; // üéØ sƒ±radaki numara

            const listEl = $('#content-list');

            if (arr.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="muted">ƒ∞√ßerik yok.</td></tr>';
                return;
            }

            let rows = '';
            arr.forEach(x => {
                const content = x.text ?? x.imageUrl ?? x.audioUrl ?? x.videoUrl ?? x.pdfUrl ?? '';
                rows += `<tr>
      <td>${x.id}</td>
      <td>${x.title || ''}</td>
      <td>${x.type}</td>
      <td class="small mono">${content.slice(0, 60)}${content.length > 60 ? '‚Ä¶' : ''}</td>
      <td><button class="btn warn small" onclick="deleteContent('${x.id}')">Sil</button></td>
    </tr>`;
            });

            listEl.innerHTML = rows;

            // ‚úÖ Burada input alanlarƒ±nƒ± otomatik dolduruyoruz
            autoFillNewContentFields();
        }

        $('#content-type').addEventListener('change', () => {
            updateContentFieldVisibility();   // ilgili inputu g√∂ster
            clearIrrelevantFields($('#content-type').value); // opsiyonel temizlik
            loadContent();                    // se√ßili tipe g√∂re listeyi getir
        });

        $('#content-save').onclick = async () => {
            const id = $('#content-id').value.trim();
            const title = $('#content-title').value.trim();
            const type = $('#content-type').value;
            if (!id) return alert("ƒ∞√ßerik ID gerekli");
            if (!title) return alert("Ba≈ülƒ±k gerekli");

            const item = { id, type, title, text: null, imageUrl: null, audioUrl: null, videoUrl: null, pdfUrl: null };

            if (type === 'text' || type === 'activity') item.text = $('#content-text').value.trim() || null;
            if (type === 'image') item.imageUrl = $('#content-image').value.trim() || null;
            if (type === 'audio') item.audioUrl = $('#content-audio').value.trim() || null;
            if (type === 'video') item.videoUrl = $('#content-video').value.trim() || null;
            if (type === 'pdf') item.pdfUrl = $('#content-pdf').value.trim() || null;


            const ref = doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', currentLessonId, 'topics', currentTopicId);
            const s = await getDoc(ref);
            const d = s.exists() ? s.data() : { id: currentTopicId, name: null, content: {} };

            d.content = d.content || {};
            d.content[type] = d.content[type] || [];
            d.content[type].push(item);

            await setDoc(ref, d, { merge: true });

            alert("‚úÖ ƒ∞√ßerik kaydedildi!");
            loadContent();
        };

        // =========================
        // üî• SORT_ORDER OTOMATƒ∞K D√úZELTME
        // =========================
        $('#fix-sort-order').addEventListener('click', async () => {
            try {
                $('#sort-status').textContent = "Sort order g√ºncelleniyor...";

                // === 1) TOP CATEGORIES ===
                const topSnap = await getDocs(collection(db, 'topCategories'));
                let topIndex = 1;
                for (const d of topSnap.docs) {
                    await updateDoc(d.ref, { sort_order: topIndex++ });
                }

                // === 2) SUBCATEGORIES ===
                for (const top of topSnap.docs) {
                    const subSnap = await getDocs(
                        collection(db, 'topCategories', top.id, 'subCategories')
                    );
                    let subIndex = 1;
                    for (const s of subSnap.docs) {
                        await updateDoc(s.ref, { sort_order: subIndex++ });
                    }
                }

                // === 3) LESSONS (sadece grades altƒ±nda) ===
                const gradeSubSnap = await getDocs(
                    collection(db, 'topCategories', 'grades', 'subCategories')
                );

                for (const sub of gradeSubSnap.docs) {
                    const lessonSnap = await getDocs(
                        collection(
                            db,
                            'topCategories', 'grades',
                            'subCategories', sub.id,
                            'lessons'
                        )
                    );

                    let lessonIndex = 1;
                    for (const l of lessonSnap.docs) {
                        await updateDoc(l.ref, { sort_order: lessonIndex++ });
                    }
                }

                // === 4) TOPICS (grades altƒ±ndaki t√ºm ders/konu) ===
                for (const sub of gradeSubSnap.docs) {
                    const lessonSnap = await getDocs(
                        collection(
                            db,
                            'topCategories', 'grades',
                            'subCategories', sub.id,
                            'lessons'
                        )
                    );

                    for (const l of lessonSnap.docs) {
                        const topicSnap = await getDocs(
                            collection(
                                db,
                                'topCategories', 'grades',
                                'subCategories', sub.id,
                                'lessons', l.id,
                                'topics'
                            )
                        );

                        let topicIndex = 1;
                        for (const t of topicSnap.docs) {
                            await updateDoc(t.ref, { sort_order: topicIndex++ });
                        }
                    }
                }

                $('#sort-status').textContent = "üéâ T√ºm sort_order alanlarƒ± g√ºncellendi!";
                alert("üéâ Sort order i≈ülemi tamamlandƒ±!");

                // Listeyi tazele
                loadTopCategories();
            } catch (e) {
                console.error(e);
                $('#sort-status').textContent = "‚ùå Sort order sƒ±rasƒ±nda hata olu≈ütu";
            }
        });


        window.deleteContent = async (id) => {
            const type = $('#content-type').value;
            const ref = doc(db, 'topCategories', currentCategoryId, 'subCategories', currentSubCategoryId, 'lessons', currentLessonId, 'topics', currentTopicId);
            const s = await getDoc(ref);
            const d = s.data();
            d.content[type] = d.content[type].filter(i => i.id !== id);
            await setDoc(ref, d, { merge: true });
            loadContent();
        };

        // ---- Content inputlarƒ±nƒ± g√∂ster/gizle ----
        function updateContentFieldVisibility() {
            const t = $('#content-type').value;

            // hepsini gizle
            $$('.content-field').forEach(el => el.classList.add('hidden'));

            // se√ßilene g√∂re g√∂ster
            if (t === 'text' || t === 'activity') $('.content-text')?.classList.remove('hidden');
            if (t === 'image') $('.content-image')?.classList.remove('hidden');
            if (t === 'audio') $('.content-audio')?.classList.remove('hidden');
            if (t === 'video') $('.content-video')?.classList.remove('hidden');
            if (t === 'pdf') $('.content-pdf')?.classList.remove('hidden');
        }

        // (opsiyonel) se√ßilmeyen alanlarƒ±n deƒüerlerini temizle
        function clearIrrelevantFields(keepType) {
            if (keepType !== 'text' && keepType !== 'activity') $('#content-text').value = '';
            if (keepType !== 'image') $('#content-image').value = '';
            if (keepType !== 'audio') $('#content-audio').value = '';
            if (keepType !== 'video') $('#content-video').value = '';
            if (keepType !== 'pdf') $('#content-pdf').value = '';
        }


        function autoFillNewContentFields() {
            if (!currentTopicId) return;

            const type = $('#content-type').value;

            // id otomatik
            $('#content-id').value = `${currentTopicId}_${type}_${currentContentCount}`;

            // Title otomatik ‚Äî ama kullanƒ±cƒ± isterse deƒüi≈ütirebilsin
            const topicName = $('#topic-label').textContent || currentTopicId;

            const typeNames = {
                text: "Metin",
                image: "G√∂rsel",
                audio: "Ses",
                video: "Video",
                pdf: "PDF",
                activity: "Etkinlik"
            };

            $('#content-title').value = `${topicName} ${typeNames[type]} ${currentContentCount}`;
        }



        window.openTopics = openTopics;
        window.deleteLesson = deleteLesson;
        window.openContent = openContent;
        window.deleteTopic = deleteTopic;
        // ===== initial load =====
        loadMovingTexts();
        loadAds();
        loadTopCategories();
    </script>
</body>

</html>